name: 'Stale issue handler'
on:
  workflow_dispatch:
  schedule:
    - cron: '30 * * * *'
permissions:
  issues: write
  pull-requests: write

jobs:
  stale-long:
    runs-on: ubuntu-latest
    steps:
      - name: get-time
        run: |
          echo "time=$(date +%I)" >> $GITHUB_ENV
      - uses: actions/stale@main
        id: stale-bug
        with:
          stale-issue-label: stale
          stale-pr-label: stale
          stale-issue-message: 'This issue has been automatically marked as stale because it has not had recent activity. It will be closed if no further activity occurs. Thank you for your contributions. Please do not bump or comment on this issue unless you are actively working on it. Stale issues that are closed are still considered.'
          stale-pr-message: 'This issue has been automatically marked as stale because it has not had recent activity. It will be closed if no further activity occurs. Thank you for your contributions. Please do not bump or comment on this issue unless you are actively working on it. Stale PRs that are closed are still considered.'
          days-before-stale: 30 # longer timer for feature requests and PRs
          days-before-close: 30
          start-date: '2020-05-07'
          ascending: ${{ contains(fromJson('["01", "03", "05", "07", "09", "11"]'), env.time) }}
          operations-per-run: 110
          exempt-issue-labels: 'Accessibility,<Bug>,<Bugfix>,<Crash / Freeze>,Organization: Bounty,Good First Issue,Help Wanted,(P1 - Critical),(P2 - High),(P3 - Medium),(P4 - Low),(P5 - Long-term),(S2 - Confirmed),0.G String Freeze,0.G Feature Freeze,0.G Content Freeze'
          exempt-pr-labels: '<Bug>,<Bugfix>,<Crash / Freeze>,Organization: Bounty,Good First Issue,(P1 - Critical),(P2 - High),(P3 - Medium),(P4 - Low),(P5 - Long-term),(S2 - Confirmed),0.G String Freeze,0.G Feature Freeze,0.G Content Freeze'
          # HACK: process PRs by filtering 'styled' tags, these are the 'most' common tags for PRs
          any-of-labels: "(S1 - Need confirmation),astyled,json-styled"
          exempt-all-milestones: true
          exempt-all-assignees: true
      - name: Print outputs
        run: echo ${{ join(steps.stale-bug.outputs.*, ',') }}

  stale-short:
    runs-on: ubuntu-latest
    steps:
      - name: get-time
        run: |
          echo "time=$(date +%I)" >> $GITHUB_ENV
      - uses: actions/stale@main
        id: stale-feature
        with:
          stale-issue-label: stale
          stale-pr-label: stale
          stale-issue-message: 'This issue has been automatically marked as stale because it has not had recent activity. It will be closed if no further activity occurs. Thank you for your contributions. Please do not bump or comment on this issue unless you are actively working on it. Stale issues that are closed are still considered.'
          stale-pr-message: 'This issue has been automatically marked as stale because it has not had recent activity. It will be closed if no further activity occurs. Thank you for your contributions. Please do not bump or comment on this issue unless you are actively working on it. Stale PRs that are closed are still considered.'
          days-before-stale: 15 # shorter timer for feature requests
          days-before-close: 15
          start-date: '2020-05-07'
          ascending: ${{ contains(fromJson('["01", "03", "05", "07", "09", "11"]'), env.time) }}
          operations-per-run: 110
          exempt-issue-labels: 'Accessibility,<Bug>,<Bugfix>,<Crash / Freeze>,Organization: Bounty,Good First Issue,Help Wanted,(P1 - Critical),(P2 - High),(P3 - Medium),(P4 - Low),(P5 - Long-term),(S2 - Confirmed),0.G String Freeze,0.G Feature Freeze,0.G Content Freeze'
          exempt-pr-labels: '<Bug>,<Bugfix>,<Crash / Freeze>,Organization: Bounty,Good First Issue,(P1 - Critical),(P2 - High),(P3 - Medium),(P4 - Low),(P5 - Long-term),(S2 - Confirmed),0.G String Freeze,0.G Feature Freeze,0.G Content Freeze'
          any-of-labels: "<Suggestion / Discussion>"
          exempt-all-milestones: true
          exempt-all-assignees: true
      - name: Print outputs
        run: echo ${{ join(steps.stale-feature.outputs.*, ',') }}
