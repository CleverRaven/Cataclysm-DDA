[
  {
    "//BEFOREMERGE:": "Consider doing something with crosses_mutation_threshold (flavour text if expected threshold category, negative stuff + replace gland trait with MUTAGEN_AVOID if not? (and hook MUTAGEN_AVOID up bc it doesn't appear to do anything rn?))",
    "type": "effect_on_condition",
    "id": "EOC_GLAND_FLUSH",
    "eoc_type": "EVENT",
    "required_event": "gains_mutation",
    "//": "Purge built up stores of mutagen post mutation and don't build up again for a period of time",
    "condition": {
      "and": [
        { "not": { "compare_string": [ { "context_val": "trait" }, "MUTAGEN_GLAND_BEAST", "MUTAGEN_GLAND_BIRD" ] } },
        { "math": [ "has_var(u_mutagen_gland_vitamin)" ] }
      ]
    },
    "effect": [
      { "math": [ "u_recently_mutated_cooldown = 36" ] },
      { "math": [ "u_vitamin('mutagen') = max( 0, u_vitamin('mutagen') - u_mutagen_gland_surplus )" ] },
      {
        "math": [ "u_vitamin(u_mutagen_gland_vitamin) = max( 0, u_vitamin(u_mutagen_gland_vitamin) - u_mutagen_gland_surplus )" ]
      }
    ]
  },
  {
    "type": "effect_on_condition",
    "id": "EOC_MUTAGEN_GLAND_COMMON_SETUP",
    "effect": [ { "math": [ "u_recently_mutated_cooldown = -1" ] }, { "math": [ "u_mutagen_gland_surplus = 0" ] } ]
  },
  {
    "type": "effect_on_condition",
    "id": "EOC_MUTAGEN_GLAND_BEAST_SETUP",
    "effect": [
      { "run_eocs": [ "EOC_MUTAGEN_GLAND_COMMON_SETUP" ] },
      { "u_add_var": "mutagen_gland_vitamin", "value": "mutagen_beast" },
      { "u_add_var": "mutagen_gland_threshold", "value": "THRESH_BEAST" }
    ]
  },
  {
    "type": "effect_on_condition",
    "id": "EOC_MUTAGEN_GLAND_BIRD_SETUP",
    "effect": [
      { "run_eocs": [ "EOC_MUTAGEN_GLAND_COMMON_SETUP" ] },
      { "u_add_var": "mutagen_gland_vitamin", "value": "mutagen_bird" },
      { "u_add_var": "mutagen_gland_threshold", "value": "THRESH_BIRD" }
    ]
  },
  {
    "type": "effect_on_condition",
    "id": "EOC_MUTAGEN_GLAND_SETUP1",
    "//TODO": "Would ideally be one big if else but there's no else_if atm so it'd be a nest nightmare",
    "eoc_type": "EVENT",
    "required_event": "gains_mutation",
    "effect": [
      {
        "if": { "compare_string": [ { "context_val": "trait" }, "MUTAGEN_GLAND_BEAST" ] },
        "then": { "run_eocs": [ "EOC_MUTAGEN_GLAND_BEAST_SETUP" ] }
      },
      {
        "if": { "compare_string": [ { "context_val": "trait" }, "MUTAGEN_GLAND_BIRD" ] },
        "then": { "run_eocs": [ "EOC_MUTAGEN_GLAND_BIRD_SETUP" ] }
      }
    ]
  },
  {
    "type": "effect_on_condition",
    "id": "EOC_MUTAGEN_GLAND_SETUP2",
    "//": "Once for each character",
    "recurrence": 1,
    "deactivate_condition": { "math": [ "u_setup_gland == 1" ] },
    "effect": [
      { "if": { "u_has_trait": "MUTAGEN_GLAND_BEAST" }, "then": { "run_eocs": [ "EOC_MUTAGEN_GLAND_BEAST_SETUP" ] } },
      { "if": { "u_has_trait": "MUTAGEN_GLAND_BIRD" }, "then": { "run_eocs": [ "EOC_MUTAGEN_GLAND_BIRD_SETUP" ] } },
      { "math": [ "u_setup_gland = 1" ] }
    ]
  },
  {
    "type": "effect_on_condition",
    "id": "EOC_AM_BECOME_MUTANT",
    "//BEFOREMERGE": "Test numbers until they feel good",
    "condition": { "math": [ "has_var(u_mutagen_gland_vitamin)" ] },
    "effect": [
      { "//": "Counter passive decay", "math": [ "u_vitamin(u_mutagen_gland_vitamin) += 1" ] },
      { "math": [ "u_vitamin('mutagen') += 1" ] },
      {
        "if": { "math": [ "u_recently_mutated_cooldown < 0" ] },
        "then": {
          "if": { "math": [ "rng( 0, u_has_trait(u_mutagen_gland_threshold) ? 30 : 5) < 1" ] },
          "then": [
            {
              "//BEFOREMERGE": "Should probably consume 'energy' in some form",
              "math": [ "u_vitamin(u_mutagen_gland_vitamin) += 50" ]
            },
            { "math": [ "u_vitamin('mutagen') += 50" ] },
            { "math": [ "u_mutagen_gland_surplus += 50" ] }
          ]
        },
        "else": [
          {
            "if": { "math": [ "u_recently_mutated_cooldown == 0" ] },
            "then": [
              {
                "//BEFOREMERGE": "Consider whether a base level is actually beneficial",
                "math": [ "u_vitamin(u_mutagen_gland_vitamin) = 200" ]
              },
              { "math": [ "u_vitamin('mutagen') = 200" ] },
              { "math": [ "u_mutagen_gland_surplus = 200" ] }
            ]
          },
          { "math": [ "u_recently_mutated_cooldown -= 1" ] }
        ]
      }
    ]
  }
]
