[
  {
    "type": "effect_on_condition",
    "id": "EOC_apply_caster_level_boost",
    "condition": { "expects_vars": [ "level_boost", "school" ] },
    "effect": [
      {
        "math": [
          "u_val('spell_level_adjustment', 'school: _school ')",
          "=",
          "floor( min(_level_boost, u_val('spell_level', 'school: _school') )"
        ]
      }
    ],
    "//": "Limits caster level boost to 1 + (highest level of spell in the relevant school) / 5"
  },
  {
    "type": "effect_on_condition",
    "id": "EOC_magus_caster_level_boost",
    "eoc_type": "EVENT",
    "required_event": "opens_spellbook",
    "condition": { "u_has_trait": "MAGUS" },
    "effect": [
      {
        "math": [
          "u_level_boost",
          "=",
          "u_val('item_count', 'item: magus_booster_1_active') + u_val('item_count', 'item: magus_booster_2_active') * 2"
        ]
      },
      { "run_eoc_with": "EOC_apply_caster_level_boost", "variables": { "level_boost": {"u_val": "level_boost"}, "school": "MAGUS" }}
    ]
  },
  {
    "type": "effect_on_condition",
    "id": "EOC_kelvinist_caster_level_boost",
    "eoc_type": "EVENT",
    "required_event": "opens_spellbook",
    "condition": { "u_has_trait": "KELVINIST" },
    "effect": [
      {
        "math": [
          "u_level_boost",
          "=",
          "u_val('item_count', 'item: kelvinist_booster_1_active') + u_val('item_count', 'item: kelvinist_booster_2_active') * 2"
        ]
      },
      { "run_eoc_with": "EOC_apply_caster_level_boost", "variables": { "level_boost": {"u_val": "level_boost"}, "school": "KELVINIST" }}
    ]
  },
  {
    "type": "effect_on_condition",
    "id": "EOC_technomancer_caster_level_boost",
    "eoc_type": "EVENT",
    "required_event": "opens_spellbook",
    "condition": { "u_has_trait": "TECHNOMANCER" },
    "effect": [
      {
        "math": [
          "u_level_boost",
          "=",
          "max( 0, u_val('effect_intensity', 'effect: technomancer_cl_booster_effect') ) + u_val('charge_count', 'item: technomancer_booster_2_active') / 5"
        ]
      },
      { "run_eoc_with": "EOC_apply_caster_level_boost", "variables": { "level_boost": {"u_val": "level_boost"}, "school": "TECHNOMANCER" }},
      {
        "math": [
          "u_doodad_boost",
          "=",
          "max( 0, u_val('spell_level_adjustment', 'school: TECHNOMANCER') - max( 0, u_val('effect_intensity', 'effect: technomancer_cl_booster_effect') ) )"
        ]
      }
    ]
  },
  {
    "type": "effect_on_condition",
    "id": "EOC_technomancer_caster_level_boost_finish_casting",
    "eoc_type": "EVENT",
    "required_event": "spellcasting_finish",
    "condition": { "and": [ { "u_has_trait": "TECHNOMANCER" }, { "compare_string": [ "TECHNOMANCER", { "context_val": "school" } ] } ] },
    "effect": [
      {
        "u_consume_item": "technomancer_booster_2_active",
        "charges": { "math": [ "floor( u_doodad_boost ) * 5" ] },
        "count": 0
      }
    ]
  },
  {
    "type": "effect_on_condition",
    "id": "EOC_biomancer_caster_level_boost",
    "eoc_type": "EVENT",
    "required_event": "opens_spellbook",
    "condition": { "u_has_trait": "BIOMANCER" },
    "effect": [
      {
        "math": [ "u_level_boost", "=", "max( 0, u_val('effect_intensity', 'effect: biomancer_cl_booster_effect') )" ]
      },
      { "run_eoc_with": "EOC_apply_caster_level_boost", "variables": { "level_boost": {"u_val": "level_boost"}, "school": "BIOMANCER" }}
    ]
  },
  {
    "type": "effect_on_condition",
    "id": "EOC_druid_caster_level_boost",
    "eoc_type": "EVENT",
    "required_event": "opens_spellbook",
    "condition": { "u_has_trait": "DRUID" },
    "effect": [
      { "math": [ "u_level_boost", "=", "0" ] },
      {
        "run_eocs": [
          {
            "id": "EOC_druid_caster_level_boost_1",
            "condition": { "or": [ { "u_is_on_terrain": "t_grass" }, { "u_is_on_terrain": "t_grass_white" }, { "u_is_on_terrain": "t_moss" } ] },
            "effect": { "math": [ "u_level_boost", "=", "1" ] }
          },
          {
            "id": "EOC_druid_caster_level_boost_2",
            "//": "Move cost 6-8?",
            "condition": {
              "or": [
                { "u_is_on_terrain": "t_grass_tall" },
                { "u_is_on_terrain": "t_grass_long" },
                { "u_is_on_terrain": "t_bamboo" },
                { "u_is_on_terrain": "t_bamboo_harvested" },
                { "u_is_on_terrain": "t_underbrush_harvested_winter" }
              ]
            },
            "effect": { "math": [ "u_level_boost", "=", "2" ] }
          },
          {
            "id": "EOC_druid_caster_level_boost_3",
            "//": "Move cost 8?",
            "condition": {
              "or": [
                { "u_is_on_terrain_with_flag": "SHRUB" },
                { "u_is_on_terrain": "t_bamboo_long" },
                { "u_is_on_terrain": "t_bamboo_tall" }
              ]
            },
            "effect": { "math": [ "u_level_boost", "=", "3" ] }
          },
          {
            "id": "EOC_druid_caster_level_boost_5",
            "//": "Move cost 4",
            "condition": {
              "or": [
                { "u_is_on_terrain": "t_tree_young" },
                { "u_is_on_terrain": "t_mega_fern" },
                { "u_is_on_terrain": "t_fungus_colony" }
              ]
            },
            "effect": { "math": [ "u_level_boost", "=", "5" ] }
          }
        ]
      },
      { "run_eoc_with": "EOC_apply_caster_level_boost", "variables": { "level_boost": {"u_val": "level_boost"}, "school": "DRUID" }}
    ]
  }
]
