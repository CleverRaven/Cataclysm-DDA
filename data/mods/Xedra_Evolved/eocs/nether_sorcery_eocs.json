[
  {
    "type": "effect_on_condition",
    "id": "EOC_XE_NETHER_SORCERY_REQUIRES_UNLOCK_SETUP",
    "recurrence": 1,
    "condition": { "not": { "u_has_trait": "XE_NETHER_SORCERY" } },
    "deactivate_condition": { "or": [ { "u_has_any_trait": [ "XE_NO_NETHER_SORCERY", "XE_NETHER_SORCERY" ] } ] },
    "effect": [ { "u_add_trait": "XE_NO_NETHER_SORCERY" } ]
  },
  {
    "type": "effect_on_condition",
    "id": "EOC_NETHER_SORCERY_LIGHT_CANCEL",
    "effect": [
      {
        "if": { "and": [ { "math": [ "u_val('fine_detail_vision_mod') >= 4" ] }, { "not": { "u_has_flag": "READ_IN_DARKNESS" } } ] },
        "then": [ "u_cancel_activity", { "u_message": "It's too dark to continue studying the occult.", "type": "bad" } ]
      }
    ]
  },
  {
    "type": "effect_on_condition",
    "id": "EOC_XE_NETHER_SORCERY_WEARINESS_COST",
    "eoc_type": "EVENT",
    "required_event": "spellcasting_finish",
    "condition": { "compare_string": [ "XE_NETHER_SORCERY", { "context_val": "school" } ] },
    "effect": [
      { "math": [ "u_spell_weariness_cost = 0" ] },
      {
        "math": [ "u_spell_weariness_cost", "=", "(6 * ( _difficulty * 0.4 ) * max( ( ( 30 - u_spell_level(_spell) ) / 30 ), 0.5) )" ]
      },
      {
        "if": { "math": [ "_success != false" ] },
        "then": [
          { "math": [ "u_calories()", "-=", "u_spell_weariness_cost" ] },
          { "math": [ "u_calories('dont_affect_weariness': true)", "+=", "u_spell_weariness_cost" ] }
        ],
        "else": [
          { "math": [ "u_calories()", "-=", "u_spell_weariness_cost / 2" ] },
          { "math": [ "u_calories('dont_affect_weariness': true)", "+=", "u_spell_weariness_cost / 2" ] }
        ]
      }
    ]
  },
  {
    "type": "effect_on_condition",
    "id": "EOC_XE_NETHER_SORCERY_RESONANCE_CONSEQUENCES",
    "eoc_type": "EVENT",
    "required_event": "spellcasting_finish",
    "condition": {
      "and": [
        { "not": { "mod_is_loaded": "mindovermatter" } },
        { "compare_string": [ "XE_NETHER_SORCERY", { "context_val": "school" } ] }
      ]
    },
    "effect": [
      { "math": [ "_consequence_duration = _difficulty * 25 * rng(0.66, 1.33)" ] },
      {
        "u_add_effect": "effect_xe_nether_resonance_consequences",
        "duration": { "math": [ "_consequence_duration" ] }
      },
      {
        "if": { "x_in_y_chance": { "x": { "math": [ "_difficulty" ] }, "y": 400 } },
        "then": { "u_add_effect": "attention", "duration": { "math": [ "_difficulty * 250 * rng(0.66, 1.33)" ] } }
      },
      {
        "if": { "x_in_y_chance": { "x": { "math": [ "_difficulty" ] }, "y": 1000 } },
        "then": { "u_add_effect": "taint", "duration": { "math": [ "_difficulty * 250 * rng(0.66, 1.33)" ] } }
      }
    ]
  }
]
