[
  {
    "id": "spell_enchanting_master",
    "type": "SPELL",
    "name": "Enchating Weapon",
    "description": "Enchant the weapon you wield with elements.  Mana cost is 500.  You can choose from 3 random elements.",
    "valid_targets": [ "self" ],
    "effect": "effect_on_condition",
    "effect_str": "EOC_enchanting_master",
    "spell_class": "perk_enchanting_master",
    "flags": [ "SILENT", "NO_PROJECTILE", "NO_FAIL", "NO_HANDS", "NO_LEGS" ],
    "shape": "blast",
    "base_casting_time": 100000,
    "base_energy_cost": 0,
    "energy_source": "MANA",
    "difficulty": 0,
    "max_level": 0,
    "teachable": false
  },
  {
    "id": "EOC_enchanting_master",
    "type": "effect_on_condition",
    "effect": {
      "if": "u_has_weapon",
      "then": [
        { "math": [ "_mana_cost", "=", "500" ] },
        {
          "if": { "math": [ "u_val('mana')", ">=", "_mana_cost" ] },
          "then": [
            {
              "u_run_inv_eocs": "random",
              "search_data": [ { "wielded_only": true } ],
              "true_eocs": "EOC_enchanting_master_selector"
            }
          ],
          "else": { "message": "You don not have enough mana.", "popup": true }
        }
      ],
      "else": { "message": "You have not wield any weapons.", "popup": true }
    }
  },
  {
    "id": "EOC_enchanting_master_init_ench",
    "type": "effect_on_condition",
    "//": "u is avatar, npc is item",
    "//1": "This will initilize trigger_count and item_ench_type",
    "//2": "Other initializations should be done in EOC_enchanting_master_init_<type>",
    "condition": { "expects_vars": [ "type", "trigger_count" ] },
    "effect": [
      { "set_string_var": { "context_val": "type" }, "target_var": { "npc_val": "item_ench_type" } },
      { "set_string_var": { "context_val": "trigger_count" }, "target_var": { "npc_val": "item_ench_trigger_count" } },
      {
        "set_string_var": { "context_val": "trigger_count" },
        "target_var": { "npc_val": "item_ench_total_trigger_count" }
      },
      {
        "set_string_var": "EOC_enchanting_master_init_<npc_val:item_ench_type>",
        "target_var": { "context_val": "init_eoc" },
        "parse_tags": true
      },
      { "run_eocs": { "context_val": "init_eoc" } }
    ]
  },
  {
    "id": "EOC_enchanting_master_remove_ench",
    "type": "effect_on_condition",
    "//": "u is avatar, npc is item",
    "//1": "This will remove trigger_count and item_ench_type",
    "//2": "Other removements should be done in EOC_enchanting_master_remove_<type>",
    "effect": [
      {
        "set_string_var": "EOC_enchanting_master_remove_<npc_val:item_ench_type>",
        "target_var": { "context_val": "remove_eoc" },
        "parse_tags": true
      },
      { "run_eocs": { "context_val": "remove_eoc" } },
      { "npc_lose_var": "item_ench_total_trigger_count" },
      { "npc_lose_var": "item_ench_trigger_count" },
      { "npc_lose_var": "item_ench_type" }
    ]
  },
  {
    "type": "jmath_function",
    "id": "is_valid_ench_option",
    "num_args": 1,
    "return": "((_0 == _rand_1) + (_0 == _rand_2) + (_0 == _rand_3) ) > 0"
  },
  {
    "id": "EOC_enchanting_master_selector",
    "type": "effect_on_condition",
    "//": "u is avatar, npc is item",
    "//rand1 ~ rand3": "they are three different numbers that determine which 3 enchantments are shown in the menu",
    "effect": {
      "if": { "math": [ "has_var(n_item_ench_type)" ] },
      "then": {
        "if": { "u_query": "Your weapon has been enchanted.  Do you want to remove its enchantment?", "default": false },
        "then": { "run_eocs": "EOC_enchanting_master_remove_ench" }
      },
      "else": {
        "if": { "math": [ "n_val('count')", ">", "1" ] },
        "then": { "message": "You can not enchant more than one item", "popup": true },
        "else": [
          { "math": [ "_ench_num", "=", "9" ] },
          { "math": [ "u_val('mana')", "-=", "_mana_cost" ] },
          { "math": [ "_rand_1", "=", "1+rand(_ench_num-1)" ] },
          { "math": [ "_rand_2", "=", "1+rand(_ench_num-2)" ] },
          { "math": [ "_rand_2", "=", "(_rand_2 < _rand_1) ? _rand_2 : _rand_2 + 1" ] },
          { "math": [ "_rand_3", "=", "1+rand(_ench_num-3)" ] },
          { "math": [ "_rand_3", "=", "(_rand_3 < min(_rand_1, _rand_2)) ? _rand_3 : _rand_3 + 1" ] },
          { "math": [ "_rand_3", "=", "(_rand_3 < max(_rand_1, _rand_2)) ? _rand_3 : _rand_3 + 1" ] },
          {
            "title": "Enchantment (Total trigger count)",
            "title": "Element (Total trigger count)",
            "hide_failing": true,
            "allow_cancel": false,
            "names": [
              "Fire (10)",
              "Ice (20)",
              "Lightning (20)",
              "Kinetic (10)",
              "Wind (50)",
              "Luck (âˆž)",
              "Death (1)",
              "Blood (15)",
              "Corruption (3)",
              "Canceled"
            ],
            "descriptions": [
              "Fire: Engulf your enemies and the surrounding in flames with each attack.",
              "Ice: Your weapon emits a chilling aura, slowing the movements of your enemies.",
              "Lightning: Electric currents surge through your weapon, shocking your foes.",
              "Kinetic: Accumulate additional damage with each enemy slain, unleashing it with your next strike.",
              "Wind: Extend the reach of your weapon with this enchantment.",
              "Luck: Reap the rewards of fortune by slaying enemies with this enchantment.",
              "Death: Infused with deathly power, your weapon has a chance to execute enemies with each strike, dealing significant damage.  The likelihood increases against weakened foes.",
              "Blood: Your attacks will leech life from your enemies.",
              "Corruption: Your slain enemies will rise corrupted, serving you as minions.",
              "Cancel this effect will <color_red>not</color> return your mana."
            ],
            "run_eoc_selector": [
              {
                "id": "EOC_enchanting_master_sel_1",
                "condition": { "math": [ "is_valid_ench_option(1)" ] },
                "effect": { "run_eoc_with": "EOC_enchanting_master_init_ench", "variables": { "type": "fire", "trigger_count": "10" } }
              },
              {
                "id": "EOC_enchanting_master_sel_2",
                "condition": { "math": [ "is_valid_ench_option(2)" ] },
                "effect": { "run_eoc_with": "EOC_enchanting_master_init_ench", "variables": { "type": "ice", "trigger_count": "20" } }
              },
              {
                "id": "EOC_enchanting_master_sel_3",
                "condition": { "math": [ "is_valid_ench_option(3)" ] },
                "effect": { "run_eoc_with": "EOC_enchanting_master_init_ench", "variables": { "type": "lightning", "trigger_count": "20" } }
              },
              {
                "id": "EOC_enchanting_master_sel_4",
                "condition": { "math": [ "is_valid_ench_option(4)" ] },
                "effect": { "run_eoc_with": "EOC_enchanting_master_init_ench", "variables": { "type": "kinetic", "trigger_count": "10" } }
              },
              {
                "id": "EOC_enchanting_master_sel_5",
                "condition": { "math": [ "is_valid_ench_option(5)" ] },
                "effect": [ { "run_eoc_with": "EOC_enchanting_master_init_ench", "variables": { "type": "wind", "trigger_count": "50" } } ]
              },
              {
                "id": "EOC_enchanting_master_sel_6",
                "condition": { "math": [ "is_valid_ench_option(6)" ] },
                "effect": [ { "run_eoc_with": "EOC_enchanting_master_init_ench", "variables": { "type": "luck", "trigger_count": "-999" } } ]
              },
              {
                "id": "EOC_enchanting_master_sel_7",
                "condition": { "math": [ "is_valid_ench_option(7)" ] },
                "effect": [ { "run_eoc_with": "EOC_enchanting_master_init_ench", "variables": { "type": "death", "trigger_count": "1" } } ]
              },
              {
                "id": "EOC_enchanting_master_sel_8",
                "condition": { "math": [ "is_valid_ench_option(8)" ] },
                "effect": [ { "run_eoc_with": "EOC_enchanting_master_init_ench", "variables": { "type": "blood", "trigger_count": "15" } } ]
              },
              {
                "id": "EOC_enchanting_master_sel_9",
                "condition": { "math": [ "is_valid_ench_option(9)" ] },
                "effect": [ { "run_eoc_with": "EOC_enchanting_master_init_ench", "variables": { "type": "corruption", "trigger_count": "3" } } ]
              },
              { "id": "EOC_enchanting_master_sel_canceled", "effect": [  ] }
            ]
          }
        ]
      }
    }
  }
]
