[
  {
    "id": "void_spider_test_item",
    "type": "ITEM",
    "subtypes": [ "TOOL" ],
    "name": { "str_sp": "void weaver effigy" },
    "description": "The severed leg of a void weaver, turned into some macabre ornament.",
    "weight": "1 g",
    "volume": "250 ml",
    "price": "30 USD",
    "price_postapoc": "100 USD",
    "symbol": "!",
    "color": "light_red",
    "use_action": {
      "type": "effect_on_conditions",
      "description": "Touch the effigy.",
      "effect_on_conditions": [ "EOC_VOID_SPIDER_RESET_VARS", "EOC_SPIDER_DIMENSION_TELEPORT" ]
    }
  },
  {
    "type": "trap",
    "id": "tr_void_spider_entry",
    "name": "",
    "color": "green",
    "symbol": "#",
    "visibility": 99,
    "always_invisible": true,
    "avoidance": 99,
    "difficulty": 99,
    "trap_radius": 0,
    "flags": [ "UNDODGEABLE" ],
    "action": "eocs",
    "eocs": [ "EOC_SPIDER_DIMENSION_TELEPORT" ]
  },
  {
    "type": "effect_on_condition",
    "id": "EOC_SPIDER_DIMENSION_TELEPORT",
    "condition": { "math": [ "void_spider_killed != 1" ] },
    "global": true,
    "effect": [
      {
        "u_travel_to_dimension": "spider_dimension",
        "npc_travel_radius": 0,
        "region_type": "spider_dimension",
        "npc_travel_filter": "none",
        "fail_message": "Nothing happens.",
        "success_message": "The abyss opens up around you."
      },
      {
        "u_location_variable": { "context_val": "spider_map" },
        "target_params": { "om_terrain": "void_spider_lair", "z": -1 },
        "terrain": "t_nether_glass_floor_basalt",
        "target_max_radius": 26
      },
      { "u_teleport": { "context_val": "spider_map" } },
      { "run_eocs": "EOC_IN_VOID_SPIDER_LAIR", "time_in_future": "1 seconds" }
    ]
  },
  {
    "type": "SPELL",
    "id": "void_spider_gore",
    "name": { "str": "Great Gore Heap", "//~": "NO_I18N" },
    "description": { "str": "Calls foul chunks of gore and acid from the great heap.", "//~": "NO_I18N" },
    "extra_effects": [
      { "id": "void_spider_acid" },
      { "id": "void_spider_gore_repeat" },
      { "id": "void_spider_acid" },
      { "id": "void_spider_gore_repeat" }
    ],
    "valid_targets": [ "ground", "self", "ally" ],
    "effect": "attack",
    "shape": "blast",
    "damage_type": "bash",
    "min_damage": 1,
    "max_damage": 1,
    "flags": [ "LOUD", "RANDOM_TARGET", "RANDOM_DAMAGE", "RANDOM_AOE", "NO_EXPLOSION_SFX", "SILENT" ],
    "base_casting_time": 100,
    "min_aoe": 2,
    "max_aoe": 4,
    "min_range": 20,
    "max_range": 20
  },
  {
    "type": "SPELL",
    "id": "void_spider_gore_repeat",
    "name": { "str": "Gore Heap - gore", "//~": "NO_I18N" },
    "description": { "str": "A single bit of gore from the heap.", "//~": "NO_I18N" },
    "valid_targets": [ "ground" ],
    "effect": "attack",
    "shape": "blast",
    "message": "",
    "damage_type": "bash",
    "min_damage": 1,
    "max_damage": 5,
    "flags": [ "LOUD", "RANDOM_TARGET", "RANDOM_DAMAGE", "RANDOM_AOE" ],
    "base_casting_time": 100,
    "min_aoe": 1,
    "max_aoe": 2,
    "min_range": 10,
    "max_range": 30,
    "field_id": "fd_gibs_flesh",
    "field_chance": 2,
    "min_field_intensity": 1,
    "max_field_intensity": 3
  },
  {
    "type": "SPELL",
    "id": "void_spider_acid",
    "name": { "str": "Gore Heap - acid", "//~": "NO_I18N" },
    "description": { "str": "A single bit of acid from the heap.", "//~": "NO_I18N" },
    "valid_targets": [ "hostile", "ground", "self", "ally" ],
    "effect": "attack",
    "shape": "blast",
    "message": "",
    "damage_type": "bash",
    "min_damage": 1,
    "max_damage": 3,
    "flags": [ "LOUD", "RANDOM_TARGET", "RANDOM_DAMAGE", "RANDOM_AOE" ],
    "base_casting_time": 100,
    "min_aoe": 1,
    "max_aoe": 1,
    "min_range": 10,
    "max_range": 30,
    "field_id": "fd_acid",
    "field_chance": 2,
    "min_field_intensity": 1,
    "max_field_intensity": 3
  },
  {
    "type": "monster_attack",
    "id": "void_spider_control",
    "attack_type": "eoc",
    "cooldown": 1,
    "range": 35,
    "eoc": [ "EOC_VOID_SPIDER_CONTROL" ]
  },
  {
    "type": "monster_attack",
    "attack_type": "melee",
    "id": "void_spider_bite",
    "cooldown": 1,
    "move_cost": 100,
    "damage_max_instance": [ { "damage_type": "stab", "amount": 12, "armor_penetration": 30000 } ],
    "hitsize_min": 4,
    "effects": [ { "id": "venom_blind", "duration": 120 } ],
    "hit_dmg_u": "%1$s's immaterial limbs crawl over you and sink their fangs in your %2$s!",
    "hit_dmg_npc": "%1$s's immaterial limbs sink into <npcname>!",
    "miss_msg_u": "%1$s's hanging limbs try to bite you, but you dodge!",
    "miss_msg_npc": "%1$s's hanging limbs try to bite <npcname>, but they dodge!",
    "no_dmg_msg_u": "%1$s's hanging limbs try to bite your %2$s, but fails to penetrate your armor!",
    "no_dmg_msg_npc": "%1$s's hanging limbs try to bite <npcname>, but fails to penetrate their armor!",
    "condition": { "or": [ { "npc_has_effect": "WEBBED" }, { "npc_has_effect": "GRABBED" } ] }
  },
  {
    "id": "void_spider_empty",
    "name": { "str": "Void spider emptiness", "//~": "NO_I18N" },
    "description": { "str": "Constantly empties the area around the spider.", "//~": "NO_I18N" },
    "valid_targets": [ "ally", "self", "hostile", "ground" ],
    "type": "SPELL",
    "flags": [ "SILENT", "NO_EXPLOSION_SFX", "IGNORE_WALLS" ],
    "effect": "ter_transform",
    "effect_str": "cavern_emptiness",
    "shape": "blast",
    "min_aoe": 12,
    "max_aoe": 12
  },
  {
    "type": "ter_furn_transform",
    "id": "cavern_emptiness",
    "terrain": [ { "result": [ "t_nether_glass_floor_basalt" ], "valid_terrain": [ "t_nether_basalt" ] } ]
  },
  {
    "type": "SPELL",
    "id": "place_void_spider",
    "name": { "str": "Place Void Spider", "//~": "NO_I18N" },
    "description": { "str": "Spawns a void spider.", "//~": "NO_I18N" },
    "flags": [ "SILENT", "HOSTILE_SUMMON", "PERMANENT", "NO_EXPLOSION_SFX" ],
    "valid_targets": [ "ground" ],
    "max_level": 1,
    "min_damage": 1,
    "max_damage": 1,
    "min_range": 0,
    "max_range": 0,
    "min_aoe": 10,
    "max_aoe": 10,
    "base_casting_time": 3,
    "shape": "blast",
    "effect": "summon",
    "effect_str": "mon_void_spider"
  },
  {
    "type": "effect_on_condition",
    "id": "EOC_IN_VOID_SPIDER_LAIR",
    "condition": { "or": [ { "u_at_om_location": "void_spider_lair" } ] },
    "deactivate_condition": { "not": { "or": [ { "u_at_om_location": "void_spider_lair" } ] } },
    "effect": [
      { "run_eocs": "EOC_IN_VOID_SPIDER_LAIR", "time_in_future": "1 seconds" },
      {
        "run_eocs": [
          {
            "id": "webbed_place_void_spider",
            "condition": {
              "and": [
                { "u_has_effect": "webbed" },
                { "one_in_chance": 6 },
                { "math": [ "u_monsters_nearby('mon_void_spider') < 1" ] },
                { "math": [ "void_spider_killed != 1" ] }
              ]
            },
            "effect": [
              { "u_message": "The emptiness shifts unnervingly, something is nearby.", "popup": true },
              { "u_cast_spell": { "id": "place_void_spider", "hit_self": true } }
            ]
          },
          {
            "id": "time_place_void_spider",
            "condition": {
              "and": [
                { "one_in_chance": 120 },
                { "math": [ "u_monsters_nearby('mon_void_spider') < 1" ] },
                { "math": [ "void_spider_killed != 1" ] }
              ]
            },
            "effect": [
              { "u_message": "The emptiness shifts unnervingly, something is nearby.", "popup": true },
              { "u_cast_spell": { "id": "place_void_spider", "hit_self": true } }
            ]
          },
          {
            "id": "webbed_place_void_maw",
            "condition": {
              "and": [
                { "or": [ { "u_has_effect": "webbed" }, { "u_has_effect": "grabbed" } ] },
                { "math": [ "u_monsters_nearby('mon_void_spider') == 1" ] },
                { "math": [ "u_monsters_nearby('mon_void_spider_maw') < 4" ] }
              ]
            },
            "effect": [
              {
                "u_spawn_monster": "mon_void_spider_maw",
                "real_count": 1,
                "min_radius": 2,
                "max_radius": 4,
                "lifespan": [ "15 seconds", "25 seconds" ]
              }
            ]
          }
        ]
      }
    ]
  },
  {
    "type": "effect_on_condition",
    "id": "EOC_VOID_SPIDER_CONTROL",
    "effect": [
      {
        "run_eocs": [
          {
            "id": "void_spider_life_remaining",
            "condition": { "and": [ { "math": [ "u_hp('ALL') < 350" ] }, { "math": [ "u_void_spider_nest_disturbed != 1" ] } ] },
            "effect": [
              { "math": [ "u_hp('ALL') += 150" ] },
              { "u_lose_effect": "maimed_armor" },
              { "u_make_sound": "the spider mimic an anguished scream", "volume": 60, "type": "speech" },
              { "run_eocs": [ "EOC_VOID_SPIDER_DISTURBED_NEST" ] },
              { "npc_location_variable": { "context_val": "disturbed_loc" }, "min_radius": 40, "max_radius": 50 },
              { "u_teleport": { "context_val": "disturbed_loc" } },
              { "math": [ "u_void_spider_nest_disturbed = 1" ] }
            ]
          },
          {
            "id": "kaleidoscope_horror",
            "effect": [
              {
                "u_spawn_monster": "mon_void_spider_maw",
                "real_count": { "math": [ "(u_hp('ALL') / 300)" ] },
                "min_radius": 1,
                "max_radius": 1,
                "lifespan": [ "2 seconds", "3 seconds" ]
              },
              {
                "//": "6 of these at the start, looses one for every 150 hp lost, monster starts at 900 hp",
                "u_spawn_monster": "mon_void_spider_limb",
                "real_count": { "math": [ "u_hp('ALL') / 150" ] },
                "min_radius": 2,
                "max_radius": 2,
                "lifespan": [ "2 seconds", "3 seconds" ]
              }
            ]
          }
        ]
      },
      { "u_location_variable": { "context_val": "my_loc" } },
      { "npc_location_variable": { "context_val": "t_loc" } },
      { "math": [ "_distance = distance('u', 'npc')" ] },
      {
        "switch": { "math": [ "_distance" ] },
        "cases": [
          { "case": 0, "effect": [ { "u_attack": "void_spider_bite" } ] },
          {
            "case": 15,
            "effect": [ { "run_eocs": [ "EOC_VOID_SPIDER_GORE" ], "variables": { "tar": { "context_val": "t_loc" } } } ]
          }
        ]
      },
      { "u_cast_spell": { "id": "void_spider_empty", "hit_self": true } }
    ]
  },
  {
    "type": "effect_on_condition",
    "id": "EOC_HURT_WEAVER",
    "condition": "has_alpha",
    "effect": [
      {
        "if": "u_is_avatar",
        "then": [
          { "message": "The limb shatters like a pane of glass!", "type": "good" },
          {
            "npc_run_monster_eocs": [ { "id": "_EOC_HURT_WEAVER", "effect": { "u_deal_damage": "pure", "amount": 20, "bodypart": "torso" } } ],
            "monster_range": 36
          }
        ]
      }
    ]
  },
  {
    "type": "effect_on_condition",
    "id": "EOC_VOID_SPIDER_GORE",
    "condition": { "math": [ "spider_gore < 10" ] },
    "effect": [
      { "u_message": "Foul heaps of rotten flesh rain down from the Weaver's maw!", "type": "bad" },
      { "u_cast_spell": { "id": "void_spider_gore" }, "loc": { "context_val": "tar" } },
      { "math": [ "spider_gore++" ] },
      {
        "run_eocs": "EOC_VOID_SPIDER_GORE",
        "time_in_future": "1 seconds",
        "variables": { "tar": { "context_val": "t_loc" } }
      }
    ],
    "false_effect": [ { "math": [ "spider_gore = 0" ] } ]
  },
  {
    "type": "effect_on_condition",
    "id": "EOC_VOID_SPIDER_DISTURBED_NEST",
    "global": true,
    "condition": { "math": [ "u_monsters_nearby('mon_void_spider') >= 1" ] },
    "effect": [
      { "u_message": "The shadows of frenzied limbs slip into reality", "type": "info" },
      {
        "u_spawn_monster": "mon_void_spider_spiderling",
        "real_count": [ 1, 3 ],
        "min_radius": 6,
        "max_radius": 12,
        "lifespan": [ "5 seconds", "25 seconds" ]
      },
      { "u_location_variable": { "global_val": "void_spider_eggs" } },
      { "u_location_variable": { "global_val": "void_spider_corpses" } },
      { "location_variable_adjust": { "global_val": "void_spider_eggs" }, "overmap_tile": true, "x_adjust": 1 },
      { "location_variable_adjust": { "global_val": "void_spider_corpses" }, "overmap_tile": true, "y_adjust": 1 },
      {
        "run_eocs": [
          {
            "id": "EOC_VOID_SPIDER_CHAOS_SWAP",
            "condition": { "one_in_chance": 10 },
            "effect": [ { "run_eocs": [ "EOC_VOID_SPIDER_CAST_CHAOS_SWAP" ] } ]
          },
          {
            "id": "EOC_VOID_SPIDER_SPAWN_HURT_JUVENILE",
            "condition": { "one_in_chance": 10 },
            "effect": [ { "u_spawn_monster": "mon_void_spider_spiderling_skewered", "real_count": 1, "min_radius": 6, "max_radius": 12 } ]
          },
          {
            "id": "EOC_VOID_SPIDER_SPAWN_EGGS",
            "condition": { "and": [ { "one_in_chance": 3 }, { "math": [ "void_spider_nest_eggs_spawned != 1" ] } ] },
            "effect": [
              {
                "mapgen_update": "void_spider_lair_eggs",
                "om_terrain": "void_spider_lair",
                "target_var": { "global_val": "void_spider_eggs" }
              },
              { "math": [ "void_spider_nest_eggs_spawned = 1" ] }
            ]
          },
          {
            "id": "EOC_VOID_SPIDER_SPAWN_CORPSES",
            "condition": { "and": [ { "one_in_chance": 6 }, { "math": [ "void_spider_nest_corpses_spawned != 1" ] } ] },
            "effect": [
              {
                "mapgen_update": "void_spider_lair_corpses",
                "om_terrain": "void_spider_lair",
                "target_var": { "global_val": "void_spider_corpses" }
              },
              { "math": [ "void_spider_nest_corpses_spawned = 1" ] }
            ]
          }
        ]
      },
      { "run_eocs": "EOC_VOID_SPIDER_DISTURBED_NEST", "time_in_future": [ "8 seconds", "10 seconds" ] }
    ]
  },
  {
    "type": "effect_on_condition",
    "id": "EOC_VOID_SPIDER_CAST_CHAOS_SWAP",
    "global": true,
    "effect": [
      { "u_location_variable": { "global_val": "void_spider_chaos_point_player" }, "min_radius": 25, "max_radius": 30 },
      { "u_teleport": { "global_val": "void_spider_chaos_point_player" } },
      { "u_message": "The cavern shifts under unseen pressure." }
    ]
  },
  {
    "type": "effect_on_condition",
    "id": "EOC_VOID_SPIDER_ON_DEATH",
    "effect": [
      { "run_eocs": "EOC_VOID_SPIDER_KILLED", "time_in_future": "0 seconds" },
      { "run_eocs": "EOC_DISSOLVE_VOID_SPIDER_LAIR", "time_in_future": "20 minutes" }
    ]
  },
  {
    "type": "effect_on_condition",
    "id": "EOC_DISSOLVE_VOID_SPIDER_LAIR",
    "global": true,
    "effect": [
      { "u_message": "The cavern folds itself beyond perception.", "popup": true },
      {
        "u_travel_to_dimension": "",
        "npc_travel_radius": 0,
        "npc_travel_filter": "none",
        "fail_message": "Nothing seems to change.",
        "success_message": "The emptiness seems to expand into endlessness."
      },
      {
        "u_location_variable": { "global_val": "nether_glass" },
        "target_params": { "om_terrain": "nether_glass_deep", "z": -10, "min_distance": 1 }
      },
      { "u_teleport": { "global_val": "nether_glass" }, "force": true },
      {
        "mapgen_update": "microlab_portal_elevator_physics_shift",
        "om_terrain": "microlab_portal_elevator_physics_glass"
      }
    ]
  },
  {
    "type": "effect_on_condition",
    "id": "EOC_VOID_SPIDER_KILLED",
    "global": true,
    "effect": [ { "math": [ "void_spider_killed = 1" ] }, { "u_add_var": "general_talk_killed_a_void_spider", "value": "yes" } ]
  },
  {
    "type": "effect_on_condition",
    "id": "EOC_VOID_SPIDER_RESET_VARS",
    "global": true,
    "//": "Reset vars for debugging.",
    "effect": [
      { "math": [ "void_spider_killed = 0" ] },
      { "math": [ "void_spider_nest_eggs_spawned = 0" ] },
      { "math": [ "void_spider_nest_corpses_spawned = 0" ] }
    ]
  }
]
