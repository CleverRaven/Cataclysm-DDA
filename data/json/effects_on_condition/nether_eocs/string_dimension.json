[
  {
    "type": "effect_on_condition",
    "id": "EOC_PORTAL_STRING_DIMENSION",
    "condition": { "math": [ "u_string_dimension_ziggurat_exit <= 3" ] },
    "effect": [
      {
        "u_travel_to_dimension": "string_dimension",
        "npc_travel_radius": 0,
        "region_type": "string_dimension",
        "npc_travel_filter": "none",
        "fail_message": "You experience brief vertigo, but nothing dangerous seems to happen.",
        "success_message": "Your glowing string flashes brightly, and your surroundings warp and fold into an ever-expanding plane of light."
      },
      {
        "u_location_variable": { "context_val": "nearest_floor" },
        "terrain": "t_string_xy",
        "target_max_radius": 20,
        "min_radius": 0,
        "max_radius": 0
      },
      { "u_teleport": { "context_val": "nearest_floor" } },
      { "math": [ "u_string_dimension_visits += 1" ] },
      { "math": [ "u_ire -= 5" ] },
      {
        "if": { "math": [ "u_string_dimension_visits == 1" ] },
        "then": [
          { "run_eocs": "EOC_PORTAL_STRING_DIMENSION_RETURN", "time_in_future": "8 minutes" },
          {
            "u_message": "You are somewhere new - an afterimage of where you were is burned into your vision, slowly fading.",
            "popup": true
          }
        ]
      },
      {
        "if": { "math": [ "u_string_dimension_visits == 2" ] },
        "then": [
          { "run_eocs": "EOC_PORTAL_STRING_DIMENSION_RETURN", "time_in_future": "64 minutes" },
          {
            "u_message": "You are somewhere you remember - an afterimage of where you were lingers at the edge of your mind's eye.",
            "popup": true
          }
        ]
      },
      {
        "if": { "math": [ "u_string_dimension_visits == 3" ] },
        "then": [
          { "run_eocs": "EOC_PORTAL_STRING_DIMENSION_RETURN", "time_in_future": "4096 minutes" },
          {
            "u_message": "You are somewhere familiar - an afterimage of where you were flashes past your mind.",
            "popup": true
          }
        ]
      },
      {
        "if": { "math": [ "u_string_dimension_visits >= 4" ] },
        "then": {
          "u_message": "You quickly and naturally orient yourself to this place - it's as if you stepped through a door that shut and vanished.",
          "popup": true
        }
      }
    ],
    "false_effect": { "u_message": "Your glowing string rattles in its container." }
  },
  {
    "type": "effect_on_condition",
    "id": "EOC_PORTAL_STRING_DIMENSION_RETURN",
    "condition": {
      "and": [
        { "test_eoc": "EOC_PORTAL_STORM_CONDITION_FLAG_PORTAL_PROOF" },
        { "not": "u_driving" },
        { "current_dimension": "string_dimension" }
      ]
    },
    "effect": [
      {
        "u_travel_to_dimension": "",
        "npc_travel_radius": 0,
        "npc_travel_filter": "none",
        "fail_message": "You feel a prickle at the edge of your senses.",
        "success_message": "Your surroundings warp and fold into the recesses of the world you know."
      },
      { "u_location_variable": { "context_val": "player_teleport_loc" }, "z_adjust": 0, "z_override": true },
      { "u_teleport": { "context_val": "player_teleport_loc" } },
      { "give_achievement": "achievement_reach_string_dimension" }
    ],
    "false_effect": [
      {
        "if": { "current_dimension": "string_dimension" },
        "then": [
          { "u_message": "You feel a prickle at the edge of your senses." },
          { "run_eocs": "EOC_PORTAL_STRING_DIMENSION_RETURN", "time_in_future": "2 minutes" }
        ]
      }
    ]
  },
  {
    "type": "effect_on_condition",
    "id": "EOC_STRING_DIMENSION_ZIGGURAT_PORTAL",
    "effect": [
      {
        "run_eoc_selector": [ "EOC_PORTAL_STRING_DIMENSION_ZIGGURAT_RETURN" ],
        "allow_cancel": true,
        "hilight_disabled": true,
        "names": [ "Try to take the hypercube" ],
        "title": "Socketed inside the device is a transparent hypercube - a cube within a cube.",
        "descriptions": [ "It's full of stars." ]
      }
    ]
  },
  {
    "type": "effect_on_condition",
    "id": "EOC_PORTAL_STRING_DIMENSION_ZIGGURAT_RETURN",
    "effect": [
      {
        "if": { "test_eoc": "EOC_PORTAL_STORM_CONDITION_FLAG_PORTAL_PROOF" },
        "then": {
          "u_message": "You touched the cube and there was an immense explosion of light.  The object is gone and you're back in the world you know.",
          "popup": true
        },
        "else": [
          {
            "u_message": "You pull the hypercube free and space around you violently bends before snapping back in place!",
            "popup": true
          },
          { "u_spawn_item": "string_dimension_hypercube", "count": 1 }
        ]
      },
      { "u_transform_radius": 5, "ter_furn_transform": "string_dimension_ziggurat_transform" },
      { "math": [ "u_string_dimension_ziggurat_exit += 1" ] },
      { "run_eocs": "EOC_PORTAL_STRING_DIMENSION_RETURN" }
    ]
  },
  {
    "type": "ter_furn_transform",
    "id": "string_dimension_ziggurat_transform",
    "furniture": [ { "result": [ "f_string_dimension_housing_imploded" ], "valid_furniture": [ "f_string_dimension_housing" ] } ]
  },
  {
    "type": "effect_on_condition",
    "id": "EOC_STRING_DIMENSION_ENTERED_EXODII_DOME",
    "eoc_type": "EVENT",
    "required_event": "avatar_enters_omt",
    "condition": {
      "and": [
        { "current_dimension": "string_dimension" },
        {
          "or": [
            { "u_near_om_location": "string_dimension_dome_x1y1z-2" },
            { "u_near_om_location": "string_dimension_dome_x2y0z-2" },
            { "u_near_om_location": "string_dimension_dome_x2y0z-1" },
            { "u_near_om_location": "string_dimension_dome_x2y0z0" },
            { "u_near_om_location": "string_dimension_dome_x1y1z0" },
            { "u_near_om_location": "string_dimension_dome_x1y2z0" },
            { "u_near_om_location": "string_dimension_dome_x0y0z2" },
            { "u_near_om_location": "string_dimension_dome_x1y0z2" },
            { "u_near_om_location": "string_dimension_dome_x2y0z2" },
            { "u_near_om_location": "string_dimension_dome_x0y1z2" },
            { "u_near_om_location": "string_dimension_dome_x1y1z2" },
            { "u_near_om_location": "string_dimension_dome_x2y1z2" },
            { "u_near_om_location": "string_dimension_dome_x0y2z2" },
            { "u_near_om_location": "string_dimension_dome_x1y2z2" },
            { "u_near_om_location": "string_dimension_dome_x2y2z2" },
            { "u_near_om_location": "string_dimension_dome_x0y0z1" },
            { "u_near_om_location": "string_dimension_dome_x1y0z1" },
            { "u_near_om_location": "string_dimension_dome_x2y0z1" },
            { "u_near_om_location": "string_dimension_dome_x0y1z1" },
            { "u_near_om_location": "string_dimension_dome_x1y1z1" },
            { "u_near_om_location": "string_dimension_dome_x2y1z1" },
            { "u_near_om_location": "string_dimension_dome_x0y2z1" },
            { "u_near_om_location": "string_dimension_dome_x1y2z1" },
            { "u_near_om_location": "string_dimension_dome_x2y2z1" }
          ]
        },
        { "not": { "compare_string": [ "yes", { "u_val": "u_found_string_dimension_exodii" } ] } }
      ]
    },
    "effect": [
      { "u_add_var": "u_found_string_dimension_exodii", "value": "yes" },
      {
        "if": { "compare_string": [ "yes", { "u_val": "general_meeting_u_met_Rubik" } ] },
        "then": {
          "u_message": "This scrap-metal dome reminds you of Rubik and the Exodii castle.  Maybe you should ask them about it?",
          "type": "neutral",
          "popup": false
        }
      }
    ]
  }
]
